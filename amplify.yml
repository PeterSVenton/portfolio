version: 1
frontend:
  phases:
    preBuild:
      commands:
        - npm ci
        - npx playwright install chromium

        - echo "Fetching secrets from SSM..."
        - |
          for secret in $(aws ssm get-parameters-by-path \
            --path "/amplify/d20tbrz1wh2p43/main/" \
            --with-decryption \
            --region "eu-west-2" \
            --query "Parameters[*].{Name:Name}" \
            --output text); do

              key=$(basename "$secret")
              value=$(aws ssm get-parameter \
                --name "$secret" \
                --with-decryption \
                --region "eu-west-2" \
                --query "Parameter.Value" \
                --output text)
              
              if [ "$key" = "BEDROCK_SYSTEM_PROMPT" ]; then
                echo "Writing System Prompt File..."
                echo  "$value" >> bedrock_system_prompt.txt
                continue
              fi

              echo "$key=$value" >> .env
              export "$key=$value"
          done
    build:
      commands:
        - npm run build
  artifacts:
    baseDirectory: .next
    files:
      - '**/*'
  cache:
    paths:
      - node_modules/**/*
      - ~/.cache/ms-playwright
